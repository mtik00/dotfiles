#!/usr/bin/env bash
# WARNING: This file is managed by chezmoi.

result=1

# remove all buildah images
buildah rm --all

# Keep trying to remove dangling images and exited processes until nothing
# is removed.  This fixes the issue of "in use by" issues.
while [ $result -ne 0 ]; do
    result=0

    if [[ -n $(podman ps -a -f "status=exited" -f "status=created" -q) ]]; then
        echo "...removing exited processes"
        podman rm $(podman ps -a -f "status=exited" -f "status=created" -q)
        result=$(( $result + 1 ))
    else
        echo "...no exited processes"
    fi

    if [[ -n $(podman images -f "dangling=true" -q) ]]; then
        echo "...removing dangling images"
        podman rmi $(podman images -f "dangling=true" -q)
        result=$(( $result + 1 ))
    else
        echo "...no dangling images"
    fi
done
